---
layout: post
title:  "(CVE-2018-0883) Windows Shell Zip File RCE Vulnerability"
date:   2021-05-10 15:10:00
categories: CVE Windows RCE
author: extr
---

아니이거 개행어케못하나여ㅛ?나중에고쳐야겠다 개행적당히 추가예정
어쩌고 저쩌고 대충 앞에는 잘라버림
test
tesdt2
test3

### 그래서 원리가 뭔데??

일반적으로 Zip 압축을 해제하기 위해 오른쪽 마우스를 클릭해서 **파일 추출** 메뉴를 선택하면 ```CZipFilder::BuildMainEnumerator()```가 호출되고, 이어서 ```CEnumArchive::_InitFromPath()``` 함수가 호출됩니다.

여기서! ```CEnumArchive::_InitFromPath()``` 함수는 위에서 제가 대강 설명하고 넘어간 Central Directory Header의 필드들에 대한 유효성 검사를 수행하는데, 그 중 ```IsValidZipItemPath()``` 함수가 포함되어 있습니다.

### IsValidZipItemPath()
위에서 언급했듯이 Central Directory Header의 필드 유효성 검사 함수 중 하나이고, 이 함수는 File Name 필드의 파일 경로 유효성을 검증하는데 여기서 보통 입력하면 안되는 특수 문자나 Directory Traversal 문자를 체크합니다!

### IsValidZipItemPath() Bypass
하지만 이 유효성 검증을 우회할 수 있는 취약점이 바로 이 취약점!
Zip 파일을 오픈하여 Explorer를 띄운 뒤, 아카이브 내에 포함된 파일을 직접 실행하는 것이져.
물론 한 가지 조건이 따라야하는데, 그건 바로 '**파일 명**'입니다리다리

![asdasa-2](/assets/contents/asdasa-2.png)

위 그림과 같이 root directory에는 Setup.foo 혹은 Install.bar라는 파일을 생성하고(이미지에는 보이지 않음), 무수한 directory traversal 문자~~의요청이!!~~로 폴더를 생성하여 최하위 단에 실제 System Drive를 기준으로 생성, 혹은 덮어 쓸 파일 및 폴더를 생성합니다.

### Setup과 Install
이 문자열이 왜 특수한 문자인지에 대해 주저리주저리 설명하고싶지만 저는 곧 이누야샤를 보러가야하므로 알아서 찾아보시길 바라겠습니다..

우선, Explorer에서 실제 아카이브 내 포함된 파일을 직접 실행시키게 되면 ```CArchiveItemContextMenu::InvokeCommand()```에 의해 ```CArchiveItemContextMenu::_OpenExploreItem()```가 호출되는데, 이 함수는 실제 파일이 실행되기 이전에 임시 디렉터리에 파일을 추출하는 역할입니다.

하지만, 추출하기 이전에 특이한 검사를 수행합니다. 추출할 파일의 확장명을 제외한 순수 파일 명과, 'Setup', 'Install'이라는 문자열과 비교하는 루틴인데요, 만약 파일 명에 저런 문자열이 포함된다면 앞서 살펴보았던 Central Directory Record의 File Name 필드에 포함된 파일 경로에 대한 유효성 검증을 수행하지 않아요! 와~대박이다~

아니 그래봤자 어차피 파일 하나로는 Directory Traversal 에바지않냐, 뭔소용이냐 하시겠지만,,, 이 루틴을 통과하게되면 ```CArchiveDList::ExtractFromZipToFile()```을 호출해서 Zip 아카이브 내 모든 파일을 임시 디렉터리에 추출하게 됩니다. 진짜 와우입니다.

### 결론
결과적으로.. Zip 파일 내에 setup 혹은 install이라는 파일 명만 존재한다면 이러한 검증을 피할 수 있다는거죠 와 정말 신기하지 않나요????????? 개쩐다면 좋아요와 구독 그리고 알람설정 부탁드립니다 감사합니다.